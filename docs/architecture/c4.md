# Sentinel Platform — C4 + Stack

## C4 — Context

```mermaid
flowchart LR
  %% Actors
  U[Cliente (App Banco/Seguradora)]
  B[Corretor/Parceiro]
  O[Operações / Compliance]

  %% System
  S((Sentinel Platform))

  %% External Systems
  OF[Open Finance / Open Insurance APIs]
  PP[Payment Provider (PIX/Boleto/Cartão)]
  NS[Notificações (Email/SMS/Push)]

  U -->|Cota, contrata, consulta| S
  B -->|Origina e acompanha propostas| S
  O -->|Revisão manual, auditoria| S

  S -->|Coleta de dados (com consentimento)| OF
  S -->|Cobrança e confirmação| PP
  S -->|Envio de mensagens| NS
```

## C4 — Containers

```mermaid
flowchart TB
  subgraph K8S[Kubernetes Cluster (Cloud)]
    GW[API Gateway / Ingress\nRate limit • AuthN/Z • Routing]

    IDN[identity-service\nOIDC/JWT • RBAC]
    Q[quote-service\nQuote/Offer • Versioning]
    R[risk-service\nUnderwriting • Score • Rules]
    P[policy-service\nIssue Policy • Lifecycle]
    BL[billing-service\nInvoice • Payment • Reconciliation]
    AU[audit-service\nAppend-only Audit Log • Queries]

    KF[(Kafka\nDomain Events)]
    DBI[(PostgreSQL\nidentity)]
    DBQ[(PostgreSQL\nquote)]
    DBR[(PostgreSQL\nrisk)]
    DBP[(PostgreSQL\npolicy)]
    DBB[(PostgreSQL\nbilling)]

    subgraph OBS[Observability]
      OTEL[OpenTelemetry Collector]
      PROM[Prometheus]
      GRAF[Grafana]
      TRC[Tempo/Jaeger]
      LOKI[Loki]
    end

    %% North-south
    GW --> Q
    GW --> IDN
    GW --> P
    GW --> BL

    %% Events
    Q -->|Publish (Outbox)| KF
    R -->|Publish (Outbox)| KF
    P -->|Publish (Outbox)| KF
    BL -->|Publish (Outbox)| KF

    KF -->|Consume quote/offer| R
    KF -->|Consume risk decisions| P
    KF -->|Consume policy issued| BL
    KF -->|Consume ALL events| AU

    %% DB
    IDN --> DBI
    Q --> DBQ
    R --> DBR
    P --> DBP
    BL --> DBB

    %% Observability (exemplo)
    Q -->|traces/metrics/logs| OTEL
    OTEL -->|metrics| PROM
    OTEL -->|traces| TRC
    PROM --> GRAF
    TRC --> GRAF
    LOKI --> GRAF
  end

  subgraph EXT[External Systems]
    OF[Open Finance / Open Insurance APIs]
    PP[Payment Provider]
    NS[Notifications]
  end

  Q -->|Data enrichment (consent)| OF
  BL -->|Charge / confirm / webhook| PP
  GW -->|Notify| NS
```

## Stack

### Linguagem & Framework
- Java 21 (ou 17 como baseline corporativo)
- Spring Boot 3.x
- Spring Security (OAuth2 Resource Server)

### APIs & Contratos
- OpenAPI 3 (Swagger)
- Contract tests (Spring Cloud Contract ou Pact)

### Persistência
- PostgreSQL por serviço (ou schemas separados no lab)
- Flyway (migrações)
- JPA/Hibernate

### Eventing
- Kafka (event-driven)
- Outbox Pattern
- Idempotência em consumidores

### Resiliência
- Resilience4j
- Rate limiting no gateway
- Backoff + DLQ

### Observabilidade
- OpenTelemetry SDK + Collector
- Prometheus + Grafana
- Tempo/Jaeger
- Loki

### Segurança & Compliance
- Mascaramento de PII
- Kubernetes Secrets / External Secrets
- Audit log append-only

### Runtime/Infra
- Docker
- Kubernetes (Helm/Kustomize)
- CI/CD: GitHub Actions ou GitLab CI
